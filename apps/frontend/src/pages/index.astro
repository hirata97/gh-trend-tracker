---
import Layout from '../layouts/Layout.astro';
import TrendList from '../components/TrendList';
import FilterBar from '../components/FilterBar';
import { getTrendsDaily, getLanguages } from '../lib/api';
import type { TrendsDailyItem, SortBy } from '@gh-trend-tracker/shared';

// Get filter parameters from query string
const url = new URL(Astro.request.url);
const selectedLanguage = url.searchParams.get('language') || undefined;
const sortByParam = url.searchParams.get('sort_by') as SortBy | null;

const validSortValues: SortBy[] = ['7d_increase', '30d_increase', '7d_rate', '30d_rate', 'total_stars'];
const sortBy: SortBy = sortByParam && validSortValues.includes(sortByParam) ? sortByParam : '7d_increase';

// Fetch data from backend API
let trends: TrendsDailyItem[] = [];
let snapshotDate: string | undefined = undefined;
let languages: (string | null)[] = [];
let error: string | null = null;

try {
  const trendsData = await getTrendsDaily({
    language: selectedLanguage,
    sort_by: sortBy,
  });
  trends = trendsData.data || [];
  snapshotDate = trendsData.metadata?.snapshot_date;

  const languagesData = await getLanguages();
  languages = languagesData.languages || [];
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error occurred';
  console.error('Failed to fetch data:', e);
}

// Build result description
let resultDescription = '';
if (selectedLanguage) {
  resultDescription += `Language: ${selectedLanguage}`;
}
const SORT_LABELS: Record<SortBy, string> = {
  '7d_increase': '7日間増加数',
  '30d_increase': '30日間増加数',
  '7d_rate': '7日間増加率',
  '30d_rate': '30日間増加率',
  'total_stars': '総スター数',
};
if (sortBy !== '7d_increase') {
  const sortLabel = SORT_LABELS[sortBy];
  resultDescription += resultDescription ? ` - Sort: ${sortLabel}` : `Sort: ${sortLabel}`;
}
---

<Layout title="GitHub Trends Tracker" snapshotDate={snapshotDate}>
  <div class="container">
    <h1>Trending Repositories</h1>

    {error ? (
      <div class="error">
        <strong>Error loading data:</strong> {error}
        <br />
        <br />
        <p>Make sure the backend API is running:</p>
        <code>cd backend && npm run dev</code>
      </div>
    ) : (
      <>
        <FilterBar
          languages={languages}
          client:load
          transition:persist="filter-bar"
        />

        <h2>
          {resultDescription ? `${resultDescription} - ` : ''}
          {trends.length} {trends.length === 1 ? 'repository' : 'repositories'} found
        </h2>

        <TrendList initialTrends={trends} client:load />
      </>
    )}
  </div>
</Layout>
