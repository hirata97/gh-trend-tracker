# Cloudflare D1 + Astro ã§ä½œã‚‹ GitHub ãƒˆãƒ¬ãƒ³ãƒ‰å¯è¦–åŒ–ã‚¢ãƒ—ãƒªã€å®Œå…¨ç„¡æ–™ã€‘

## ã¯ã˜ã‚ã«

æŠ€è¡“é¸å®šã‚„å­¦ç¿’ã®å„ªå…ˆé †ä½ã‚’æ±ºã‚ã‚‹éš›ã€ã€Œä»Šã©ã‚“ãªãƒªãƒã‚¸ãƒˆãƒªãŒãƒˆãƒ¬ãƒ³ãƒ‰ãªã®ã‹ï¼Ÿã€ã‚’çŸ¥ã‚ŠãŸã„ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

æœ¬è¨˜äº‹ã§ã¯ã€**GitHub APIã‹ã‚‰è‡ªå‹•çš„ã«ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã€Webã§å¯è¦–åŒ–ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ã‚’1æ—¥ã§æ§‹ç¯‰ã—ãŸéç¨‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚å…¨ã¦ç„¡æ–™æ ã§é‹ç”¨å¯èƒ½ã§ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

### å®Œæˆã—ãŸã‚‚ã®

- âœ… æ¯æ—¥500ãƒªãƒã‚¸ãƒˆãƒªï¼ˆ10è¨€èªÃ—50ä»¶ï¼‰ã‚’è‡ªå‹•åé›†
- âœ… è¨€èªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ä»˜ãWebUI
- âœ… GitHub Actionsã§å®Œå…¨è‡ªå‹•åŒ–
- âœ… é‹ç”¨ã‚³ã‚¹ãƒˆ: **å®Œå…¨ç„¡æ–™**

### ãƒ‡ãƒ¢

![GitHub Trends Tracker ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼ˆæƒ³å®šï¼‰]

- ãƒªãƒã‚¸ãƒˆãƒªä¸€è¦§ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
- ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§è¨€èªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ã‚¹ã‚¿ãƒ¼æ•°ã€èª¬æ˜æ–‡ã‚’è¡¨ç¤º

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **Cloudflare Workers**: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ©ãƒ³ã‚¿ã‚¤ãƒ 
- **Hono**: è»½é‡Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **Cloudflare D1**: ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **Drizzle ORM**: TypeScript ORM

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **Astro 4**: é™çš„ã‚µã‚¤ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼
- **React 18**: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
- **TypeScript**: å‹å®‰å…¨æ€§

### è‡ªå‹•åŒ–
- **GitHub Actions**: æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿åé›†

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†
- **npm workspaces**: ãƒ¢ãƒãƒ¬ãƒæ§‹æˆ

### ãªãœã“ã®æ§‹æˆï¼Ÿ

1. **å®Œå…¨ç„¡æ–™ã§é‹ç”¨å¯èƒ½**
   - Cloudflare Workers/D1ã®ç„¡æ–™æ ãŒéå¸¸ã«å¯›å®¹
   - GitHub Actionsã‚‚ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªãªã‚‰ç„¡åˆ¶é™

2. **ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ•ãƒªãƒ¼**
   - ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ä¸è¦
   - ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è‡ªå‹•

3. **TypeScriptã§å‹å®‰å…¨**
   - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å‹ã‚’å…±æœ‰
   - é–‹ç™ºä½“é¨“ãŒè‰¯ã„

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions     â”‚ æ¯æ—¥UTC 0:00å®Ÿè¡Œ
â”‚  (ãƒ‡ãƒ¼ã‚¿åé›†)        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ GitHub API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub API         â”‚ ãƒˆãƒ¬ãƒ³ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
â”‚  /search/repos      â”‚ 500ä»¶/æ—¥
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ ä¿å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloudflare D1      â”‚ SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚  (repositories +    â”‚ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼
â”‚   repo_snapshots)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ èª­ã¿å–ã‚Š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloudflare Workers â”‚ Hono API
â”‚  (Hono API)         â”‚ /api/trends
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ å–å¾—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Astro + React      â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚  (Frontend)         â”‚ http://localhost:4321
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **ãƒ‡ãƒ¼ã‚¿åé›†**: GitHub Actions â†’ GitHub API â†’ D1
2. **ãƒ‡ãƒ¼ã‚¿å–å¾—**: Frontend â†’ Workers API â†’ D1
3. **é »åº¦**: åé›†ã¯1æ—¥1å›ã€è¡¨ç¤ºã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ 

---

## å®Ÿè£…ã®å…¨å·¥ç¨‹

é–‹ç™ºæ™‚é–“: **ç´„9æ™‚é–“** (1æ—¥)

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®è¨­è¨ˆ

ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã‚’æ¡ç”¨ã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’æ˜ç¢ºã«åˆ†é›¢ã€‚

```
gh-trend-tracker/
â”œâ”€â”€ backend/                    # Cloudflare Workers API
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ routes/            # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ db/schema.ts       # Drizzle ORM
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”œâ”€â”€ collect-data.ts    # ãƒ‡ãƒ¼ã‚¿åé›†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â””â”€â”€ lib/               # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â””â”€â”€ wrangler.jsonc
â”œâ”€â”€ frontend/                   # Astro ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ lib/
â”‚   â””â”€â”€ astro.config.mjs
â”œâ”€â”€ shared/                     # å…±é€šå‹å®šç¾©
â”‚   â””â”€â”€ types/api.ts
â””â”€â”€ package.json                # ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç®¡ç†
```

#### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‘½åã®æ„å›³

å½“åˆã¯ `api/` ã¨ã„ã†åå‰ã§ã—ãŸãŒã€å°†æ¥çš„ã«ãƒ‡ãƒ¼ã‚¿åé›†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ãƒãƒƒãƒå‡¦ç†ã‚’è¿½åŠ ã™ã‚‹äºˆå®šã ã£ãŸãŸã‚ã€`backend/` ã«ãƒªãƒãƒ¼ãƒ ã—ã¾ã—ãŸã€‚

- `api` = HTTPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿
- `backend` = ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å…¨ä½“ï¼ˆAPI + ãƒãƒƒãƒå‡¦ç†ï¼‰

```bash
git mv api backend
```

---

## 2. ãƒ‡ãƒ¼ã‚¿åé›†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè£…

### 2-1. GitHub APIçµ±åˆ

GitHub REST APIã® `/search/repositories` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã€‚

**æ¤œç´¢ã‚¯ã‚¨ãƒªä¾‹**:
```
language:TypeScript created:>2025-12-01 sort:stars
```

- ç›´è¿‘1ãƒ¶æœˆã«ä½œæˆã•ã‚ŒãŸãƒªãƒã‚¸ãƒˆãƒª
- ã‚¹ã‚¿ãƒ¼æ•°ã§ã‚½ãƒ¼ãƒˆ
- è¨€èªã§çµã‚Šè¾¼ã¿

**å¯¾è±¡è¨€èªï¼ˆ10è¨€èªï¼‰**:
- TypeScript, JavaScript, Python, Go, Rust
- Java, C++, Ruby, PHP, Swift

**å–å¾—æ•°**: å„è¨€èª50ä»¶ Ã— 10è¨€èª = 500ãƒªãƒã‚¸ãƒˆãƒª/æ—¥

### 2-2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ

GitHub APIã®æ¤œç´¢ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ **30ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ†** ã®åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚

```typescript
// backend/scripts/lib/rate-limiter.ts
export class RateLimiter {
  private lastRequestTime = 0;
  private minInterval: number;

  constructor(requestsPerMinute: number = 30) {
    this.minInterval = (60 * 1000) / requestsPerMinute;
  }

  async throttle(): Promise<void> {
    const now = Date.now();
    const timeSinceLastRequest = now - this.lastRequestTime;

    if (timeSinceLastRequest < this.minInterval) {
      const sleepTime = this.minInterval - timeSinceLastRequest;
      await this.sleep(sleepTime);
    }

    this.lastRequestTime = Date.now();
  }

  private sleep(ms: number): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }
}
```

### 2-3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã‚’æ¡ç”¨ã—ã€æ—¥æ¬¡ã§ãƒªãƒã‚¸ãƒˆãƒªã®æŒ‡æ¨™ã‚’è¨˜éŒ²ã€‚

**repositories ãƒ†ãƒ¼ãƒ–ãƒ«**:
```sql
CREATE TABLE repositories (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  repo_id INTEGER UNIQUE NOT NULL,  -- GitHub ID
  name TEXT NOT NULL,
  full_name TEXT UNIQUE NOT NULL,
  owner TEXT NOT NULL,
  language TEXT,
  description TEXT,
  html_url TEXT NOT NULL,
  topics TEXT,  -- JSONæ–‡å­—åˆ—
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);
```

**repo_snapshots ãƒ†ãƒ¼ãƒ–ãƒ«**:
```sql
CREATE TABLE repo_snapshots (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  repo_id INTEGER NOT NULL,
  stars INTEGER NOT NULL DEFAULT 0,
  forks INTEGER NOT NULL DEFAULT 0,
  watchers INTEGER NOT NULL DEFAULT 0,
  open_issues INTEGER NOT NULL DEFAULT 0,
  snapshot_date TEXT NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(repo_id, snapshot_date)  -- 1æ—¥1ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
);
```

**è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ**:
- `repositories`: `INSERT OR REPLACE` ã§upsert
- `repo_snapshots`: `INSERT OR IGNORE` ã§é‡è¤‡é˜²æ­¢
- å°†æ¥çš„ã«ã‚¹ã‚¿ãƒ¼å¢—åŠ ç‡ã‚’è¨ˆç®—å¯èƒ½

---

## 3. æœ€å¤§ã®èª²é¡Œ: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã®é«˜é€ŸåŒ–

### å•é¡Œç™ºç”Ÿ

åˆæœŸå®Ÿè£…ã§ã¯ã€å„ãƒªãƒã‚¸ãƒˆãƒªã”ã¨ã«wranglerã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã—ãŸã€‚

```typescript
// âŒ éåŠ¹ç‡ãªå®Ÿè£…
for (const repo of repos) {
  execSync(`npx wrangler d1 execute ... --command="INSERT ..."`);
  execSync(`npx wrangler d1 execute ... --command="INSERT ..."`);
}
```

**å®Ÿè¡Œæ™‚é–“**: 500ãƒªãƒã‚¸ãƒˆãƒª Ã— 2ãƒ†ãƒ¼ãƒ–ãƒ« = 1000å›ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ â†’ **10-20åˆ†**

### è§£æ±ºç­–: ä¸€æ‹¬ä¿å­˜

å…¨SQLæ–‡ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ã€1å›ã®wranglerã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã€‚

```typescript
// âœ… æ”¹å–„å¾Œã®å®Ÿè£…
export class DatabaseManager {
  private executeSQLFile(sqlStatements: string[]): void {
    const tempFile = join(process.cwd(), '.temp-insert.sql');

    try {
      // å…¨SQLæ–‡ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—
      writeFileSync(tempFile, sqlStatements.join('\n'), 'utf-8');

      // 1å›ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œ
      const command = `npx wrangler d1 execute ${this.config.databaseName} --file=${tempFile} ${flag}`;
      execSync(command, { stdio: 'inherit' });

      // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      unlinkSync(tempFile);
    } catch (error) {
      unlinkSync(tempFile);
      throw error;
    }
  }

  async saveRepos(repos: GitHubRepo[]): Promise<Result> {
    const sqlStatements: string[] = [];

    for (const repo of repos) {
      sqlStatements.push(this.generateRepositoryInsert(repo));
      sqlStatements.push(this.generateSnapshotInsert(repo, snapshotDate));
    }

    this.executeSQLFile(sqlStatements);
    return { success: repos.length, failed: 0 };
  }
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„çµæœ

- **ä¿®æ­£å‰**: 10-20åˆ†
- **ä¿®æ­£å¾Œ**: **ç´„60ç§’**
- **æ”¹å–„ç‡**: ç´„10-20å€é«˜é€ŸåŒ– ğŸš€

---

## 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…

### 4-1. Astro + React ã®é¸å®šç†ç”±

- **Astro**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ã€SSG/SSRã«å¯¾å¿œ
- **React**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®å‹•çš„ãªéƒ¨åˆ†ã®ã¿

**éƒ¨åˆ†çš„ãƒã‚¤ãƒ‰ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
```astro
---
// src/pages/index.astro
import TrendList from '../components/TrendList';
import { getTrends } from '../lib/api';

const trends = await getTrends();  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰
---

<Layout>
  <TrendList
    initialTrends={trends}
    client:load  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§æœ‰åŠ¹åŒ–
  />
</Layout>
```

### 4-2. è¨€èªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§å®Ÿè£…ã€‚

```tsx
// src/components/LanguageFilter.tsx
export default function LanguageFilter({ languages }: Props) {
  const handleChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const language = e.target.value;

    if (language === '') {
      window.location.href = '/';
    } else {
      window.location.href = `/?language=${encodeURIComponent(language)}`;
    }
  };

  return (
    <select onChange={handleChange}>
      <option value="">All Languages</option>
      {languages.map((lang) => (
        <option key={lang} value={lang}>{lang}</option>
      ))}
    </select>
  );
}
```

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**:
- `/?language=TypeScript` â†’ TypeScriptã®ã¿è¡¨ç¤º
- `/` â†’ å…¨è¨€èªè¡¨ç¤º

### 4-3. ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°

ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã‚ãšã€ç´ ã®CSSã§ã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚

```css
/* src/styles/global.css */
body {
  font-family: system-ui, sans-serif;
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  text-align: left;
  padding: 0.75rem;
  border-bottom: 1px solid #e1e4e8;
}

tr:hover {
  background: #f6f8fa;
}
```

---

## 5. GitHub Actions è‡ªå‹•åŒ–

### 5-1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®š

æ¯æ—¥UTC 0:00ï¼ˆæ—¥æœ¬æ™‚é–“ 9:00ï¼‰ã«è‡ªå‹•å®Ÿè¡Œã€‚

```yaml
# .github/workflows/collect-data.yml
name: Daily GitHub Trends Collection

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  collect-data:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Collect GitHub trends data
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TRENDS_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd backend
          npm run collect -- --remote
```

### 5-2. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®š

**å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆ3ã¤ï¼‰**:

| ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå | ç”¨é€” | å–å¾—æ–¹æ³• |
|---|---|---|
| `GH_TRENDS_TOKEN` | GitHub API ã‚¢ã‚¯ã‚»ã‚¹ | https://github.com/settings/tokens <br> Scopes: `public_repo` |
| `CLOUDFLARE_API_TOKEN` | Cloudflare API ã‚¢ã‚¯ã‚»ã‚¹ | https://dash.cloudflare.com/profile/api-tokens <br> æ¨©é™: `D1:Edit`, `Workers Scripts:Edit` |
| `CLOUDFLARE_ACCOUNT_ID` | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè­˜åˆ¥å­ | `npx wrangler whoami` ã§ç¢ºèª |

**è¨­å®šå ´æ‰€**:
```
GitHub ãƒªãƒã‚¸ãƒˆãƒª > Settings > Secrets and variables > Actions
```

---

## 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

é–‹ç™ºä¸­ã«é­é‡ã—ãŸå•é¡Œã¨è§£æ±ºæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### å•é¡Œ1: `await` ã‚’éasyncé–¢æ•°ã§ä½¿ç”¨

**ã‚¨ãƒ©ãƒ¼**:
```
Error: "await" can only be used inside an "async" function
```

**åŸå› **: ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿ã§ dynamic import ã‚’ä½¿ç”¨ã—ã¦ã„ãŸ

```typescript
// âŒ å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
function loadEnv() {
  const fs = await import('fs');  // await in non-async function
  const path = await import('path');
  // ...
}
```

**è§£æ±º**: åŒæœŸçš„ãª import ã«å¤‰æ›´

```typescript
// âœ… ä¿®æ­£å¾Œ
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

function loadEnv() {
  const envPath = join(process.cwd(), '.env');
  if (existsSync(envPath)) {
    const envContent = readFileSync(envPath, 'utf-8');
    // ...
  }
}
```

### å•é¡Œ2: Cloudflareèªè¨¼ã‚¨ãƒ©ãƒ¼

**ã‚¨ãƒ©ãƒ¼**:
```
âœ˜ [ERROR] Authentication error [code: 10000]
```

**åŸå› **: Cloudflare APIãƒˆãƒ¼ã‚¯ãƒ³ã«D1ã®æ¨©é™ãŒãªã„

Cloudflareã® **"Edit Cloudflare Workers"** ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã¯ã€`D1:Edit` æ¨©é™ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

**è§£æ±º**: ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ã§æ˜ç¤ºçš„ã«æ¨©é™è¿½åŠ 

1. https://dash.cloudflare.com/profile/api-tokens
2. **Create Custom Token**
3. Permissions:
   - âœ… `Account > D1 > Edit`
   - âœ… `Account > Workers Scripts > Edit`
4. Account Resources: è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠ
5. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆ â†’ GitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ›´æ–°

### å•é¡Œ3: npmä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—

**ã‚¨ãƒ©ãƒ¼**:
```
npm error ENOTEMPTY: directory not empty
```

**åŸå› **: WSLç’°å¢ƒã§npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç ´æ

**è§£æ±º**:
```bash
rm package-lock.json
npm install
```

---

## æŠ€è¡“çš„ãªå­¦ã³ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. Cloudflare D1ã®ã‚¯ã‚»

**ãƒ­ãƒ¼ã‚«ãƒ«ã¨ãƒªãƒ¢ãƒ¼ãƒˆã®åˆ†é›¢**:
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«D1ï¼ˆé–‹ç™ºç”¨ï¼‰
npx wrangler d1 execute gh-trends-db --command="SELECT ..." --local

# ãƒªãƒ¢ãƒ¼ãƒˆD1ï¼ˆæœ¬ç•ªç”¨ï¼‰
npx wrangler d1 execute gh-trends-db --command="SELECT ..." --remote
```

**ä¸€æ‹¬INSERTã®é«˜é€ŸåŒ–**:
- ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå¤§ãã„
- SQLãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ãŒåœ§å€’çš„ã«é€Ÿã„

### 2. npm workspaces ã®æ´»ç”¨

ãƒ¢ãƒãƒ¬ãƒã§ã‚µãƒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†ã€‚

```json
// ãƒ«ãƒ¼ãƒˆpackage.json
{
  "workspaces": ["shared", "backend", "frontend"],
  "scripts": {
    "dev:backend": "npm run dev --workspace=backend",
    "dev:frontend": "npm run dev --workspace=frontend"
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ä¾å­˜é–¢ä¿‚ã‚’ä¸€å…ƒç®¡ç†
- å…±é€šã®node_modules
- å‹å®šç¾©ã‚’å…±æœ‰å¯èƒ½

### 3. å‹å®‰å…¨ãªé–‹ç™º

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å‹ã‚’å…±æœ‰ã€‚

```typescript
// shared/types/api.ts
export interface TrendItem {
  repoId: number;
  fullName: string;
  language: string | null;
  currentStars: number;
  description: string | null;
  htmlUrl: string;
}

export interface TrendsResponse {
  trends: TrendItem[];
}
```

```typescript
// frontend/src/lib/api.ts
import type { TrendsResponse } from '@shared/types/api';

export async function getTrends(): Promise<TrendsResponse> {
  const response = await fetch(`${API_BASE}/api/trends`);
  return response.json();  // å‹å®‰å…¨
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚³ã‚¹ãƒˆ

### å®Ÿè¡Œæ™‚é–“

| å‡¦ç† | æ™‚é–“ |
|---|---|
| ãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆ500ãƒªãƒã‚¸ãƒˆãƒªï¼‰ | ç´„20ç§’ |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ | ç´„60ç§’ |
| åˆè¨ˆ | **ç´„80ç§’/æ—¥** |

### ç„¡æ–™æ ã®ä½™è£•åº¦

**Cloudflare Workers**:
- åˆ¶é™: 10ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥
- ä½¿ç”¨: æ•°ç™¾ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ï¼ˆAPIå‘¼ã³å‡ºã—ï¼‰
- **ä½™è£•åº¦: 99%ä»¥ä¸Š**

**Cloudflare D1**:
- åˆ¶é™: 500ä¸‡èª­ã¿å–ã‚Š/æ—¥ã€10ä¸‡æ›¸ãè¾¼ã¿/æ—¥
- ä½¿ç”¨: 1000æ›¸ãè¾¼ã¿/æ—¥ã€æ•°åƒèª­ã¿å–ã‚Š/æ—¥
- **ä½™è£•åº¦: 99%ä»¥ä¸Š**

**GitHub Actions**:
- åˆ¶é™: ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªã¯ç„¡åˆ¶é™
- ä½¿ç”¨: ç´„2åˆ†/æ—¥
- **ä½™è£•åº¦: ç„¡åˆ¶é™**

### å®Ÿè³ªçš„ãªã‚³ã‚¹ãƒˆ

**å®Œå…¨ç„¡æ–™ã§é‹ç”¨å¯èƒ½** ğŸ‰

---

## ä»Šå¾Œã®æ‹¡å¼µæ¡ˆ

### çŸ­æœŸçš„ãªæ”¹å–„
- ã‚¨ãƒ©ãƒ¼é€šçŸ¥ï¼ˆSlack/Discordé€£æºï¼‰
- ãƒ‡ãƒ¼ã‚¿åé›†æ™‚é–“ã®æœ€é©åŒ–
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–

### ä¸­æœŸçš„ãªæ©Ÿèƒ½è¿½åŠ 
- æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•ï¼ˆRechartsï¼‰ã§ã‚¹ã‚¿ãƒ¼æ¨ç§»ã‚’å¯è¦–åŒ–
- 7æ—¥é–“ã®ã‚¹ã‚¿ãƒ¼å¢—åŠ ç‡è¨ˆç®—
- ãƒªãƒã‚¸ãƒˆãƒªè©³ç´°ãƒšãƒ¼ã‚¸
- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ã®å¼·åŒ–

### é•·æœŸçš„ãªå±•é–‹
- Cloudflare Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
- ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
- ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã¨ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½
- é€±æ¬¡ã‚µãƒãƒªãƒ¼ã®ãƒ¡ãƒ¼ãƒ«é€šçŸ¥

---

## ã¾ã¨ã‚

### é”æˆã§ããŸã“ã¨

1. âœ… GitHub APIã‹ã‚‰æ¯æ—¥500ãƒªãƒã‚¸ãƒˆãƒªã‚’è‡ªå‹•åé›†
2. âœ… Cloudflare D1ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ–¹å¼ã§ãƒ‡ãƒ¼ã‚¿ä¿å­˜
3. âœ… Astro + Reactã§è¨€èªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯èƒ½ãªWebUI
4. âœ… GitHub Actionsã§å®Œå…¨è‡ªå‹•åŒ–
5. âœ… **å®Œå…¨ç„¡æ–™ã§é‹ç”¨å¯èƒ½ãªMVPå®Œæˆ**

### é–‹ç™ºæ™‚é–“

- **è¨ˆç”»ãƒ»è¨­è¨ˆ**: 1æ™‚é–“
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…**: 3æ™‚é–“
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…**: 2æ™‚é–“
- **GitHub Actionsè¨­å®š**: 2æ™‚é–“
- **ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: 1æ™‚é–“
- **åˆè¨ˆ**: **ç´„9æ™‚é–“ï¼ˆ1æ—¥ï¼‰**

### å­¦ã‚“ã ã“ã¨

1. **MVPé–‹ç™ºã§ã¯ã€Œæœ€å°é™ã§å‹•ãã‚‚ã®ã€ã‚’æœ€å„ªå…ˆ**
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã¯å¾Œã‹ã‚‰æœ€é©åŒ–
   - ä¸€æ‹¬ä¿å­˜ã§10-20å€é«˜é€ŸåŒ–ã‚’é”æˆ

2. **ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã®å¨åŠ›**
   - ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ä¸è¦
   - ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è‡ªå‹•
   - ç„¡æ–™æ ãŒéå¸¸ã«å¯›å®¹

3. **å‹å®‰å…¨æ€§ã®é‡è¦æ€§**
   - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å‹å…±æœ‰
   - é–‹ç™ºåŠ¹ç‡ãŒå¤§å¹…ã«å‘ä¸Š

4. **è‡ªå‹•åŒ–ã«ã‚ˆã‚‹é‹ç”¨è² è·ã®å‰Šæ¸›**
   - GitHub Actionsã§å®Œå…¨è‡ªå‹•åŒ–
   - æ‰‹å‹•ä½œæ¥­ã‚¼ãƒ­

---

## ãƒªãƒã‚¸ãƒˆãƒª

å®Œå…¨ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯GitHubã§å…¬é–‹ã—ã¦ã„ã¾ã™ï¼š

**https://github.com/hirata97/gh-trend-tracker**

- â­ ã‚¹ã‚¿ãƒ¼ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼
- ğŸ› Issueãƒ»PRã‚‚æ­“è¿ã§ã™

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Cloudflare Workers ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.cloudflare.com/workers/)
- [Cloudflare D1 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.cloudflare.com/d1/)
- [Astro ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.astro.build/)
- [Hono ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://hono.dev/)
- [GitHub REST API](https://docs.github.com/en/rest)

---

**è‘—è€…**: hirata97
**å…¬é–‹æ—¥**: 2026-01-14
**ã‚¿ã‚°**: #Cloudflare #Astro #React #TypeScript #ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ #GitHub
