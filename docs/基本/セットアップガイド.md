# セットアップガイド

GitHub Trend Trackerの開発環境セットアップ手順を説明します。

## 必要な環境

### 必須ツール

| ツール             | 最小バージョン | 確認コマンド          |
| ------------------ | -------------- | --------------------- |
| **Node.js**        | 20.0.0以上     | `node --version`      |
| **npm**            | 10.0.0以上     | `npm --version`       |
| **Git**            | 最新版推奨     | `git --version`       |

### 必要なアカウント

- **GitHubアカウント** - Personal Access Token取得用
- **Cloudflareアカウント** - Workers/D1/Pages利用（無料枠で運用可能）

## セットアップ手順

### 1. リポジトリのクローン

```bash
git clone https://github.com/YOUR_USERNAME/gh-trend-tracker.git
cd gh-trend-tracker
```

### 2. 依存関係のインストール

プロジェクトルートで以下を実行：

```bash
npm install
```

npm workspacesにより、全てのワークスペース（backend, frontend, shared）の依存関係が一括でインストールされます。

### 3. Cloudflareログイン

Backendディレクトリに移動してWranglerでログイン：

```bash
cd apps/backend
npx wrangler login
```

ブラウザが開くので、Cloudflareアカウントで認証してください。

### 4. GitHub Personal Access Tokenの取得

1. GitHubの [Personal Access Tokens](https://github.com/settings/tokens) ページにアクセス
2. **Generate new token (classic)** をクリック
3. 以下のスコープを選択：
   - `public_repo` - パブリックリポジトリへの読み取りアクセス
4. トークンを生成してコピー（**再表示できないので必ず保存**）

### 5. 環境変数の設定

`apps/backend/`に`.env`ファイルを作成：

```bash
cd apps/backend
touch .env
```

以下の内容を記述：

```env
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**注意**: `.env`ファイルは`.gitignore`に含まれており、コミットされません。

### 6. D1データベースの作成

#### 6.1 データベースの作成

```bash
cd apps/backend
npx wrangler d1 create gh-trends-db
```

出力例：

```
✅ Successfully created DB 'gh-trends-db'!

[[d1_databases]]
binding = "DB"
database_name = "gh-trends-db"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

#### 6.2 wrangler.jsoncの更新

`apps/backend/wrangler.jsonc`の`d1_databases`セクションを上記の出力で更新：

```jsonc
{
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "gh-trends-db",
      "database_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"  // ここを更新
    }
  ]
}
```

**重要**: このIDは環境固有です。コミット前に必ず確認してください。

#### 6.3 スキーマの適用（リモートDB）

```bash
npx wrangler d1 execute gh-trends-db --file=schema/schema.sql --remote
```

#### 6.4 ローカル開発用DBの作成（オプション）

```bash
npx wrangler d1 execute gh-trends-db --file=schema/schema.sql --local
```

### 7. 開発サーバーの起動

プロジェクトルートに戻って開発サーバーを起動：

```bash
cd ../..  # プロジェクトルートへ

# バックエンド
npm run dev:backend
# → http://localhost:8787

# フロントエンド（別ターミナルで）
npm run dev:frontend
# → http://localhost:4321
```

## 開発コマンド一覧

### 基本コマンド（プロジェクトルートから実行）

| コマンド               | 説明                                   |
| ---------------------- | -------------------------------------- |
| `npm run dev:backend`  | バックエンド開発サーバー起動           |
| `npm run dev:frontend` | フロントエンド開発サーバー起動         |
| `npm run build`        | 全ワークスペースのビルド               |
| `npm run test`         | 全ワークスペースのテスト実行           |
| `npm run lint`         | ESLintによるコードチェック             |
| `npm run format`       | Prettierによるコード整形               |

### Backendコマンド（`apps/backend/`で実行）

| コマンド                  | 説明                                     |
| ------------------------- | ---------------------------------------- |
| `npm run dev`             | Wrangler開発サーバー起動                 |
| `npm run deploy`          | Cloudflare Workersにデプロイ             |
| `npm run test`            | Vitestでテスト実行                       |
| `npm run cf-typegen`      | Wrangler型定義生成（D1バインディング型） |
| `npm run collect`         | ローカルDBにデータ収集                   |
| `npm run collect -- --remote` | リモートDBにデータ収集               |

### Frontendコマンド（`apps/frontend/`で実行）

| コマンド         | 説明                      |
| ---------------- | ------------------------- |
| `npm run dev`    | Astro開発サーバー起動     |
| `npm run build`  | 本番用ビルド              |
| `npm run preview`| ビルド結果のプレビュー    |

## データベース操作

### スキーマの再適用

データベース構造を変更した場合：

```bash
cd apps/backend

# リモートDB
npx wrangler d1 execute gh-trends-db --file=schema/schema.sql --remote

# ローカルDB
npx wrangler d1 execute gh-trends-db --file=schema/schema.sql --local
```

### データベースの直接クエリ

```bash
cd apps/backend

# リモートDBクエリ
npx wrangler d1 execute gh-trends-db \
  --command="SELECT * FROM repositories LIMIT 10" \
  --remote

# ローカルDBクエリ
npx wrangler d1 execute gh-trends-db \
  --command="SELECT COUNT(*) FROM repositories" \
  --local
```

### TypeScript型の生成

Cloudflare WorkersのバインディングをTypeScriptで型安全に扱うために：

```bash
cd apps/backend
npm run cf-typegen
```

これにより`.wrangler/types/`に型定義ファイルが生成されます。

## 初回データ収集

開発環境でデータを収集するには：

```bash
cd apps/backend

# ローカルDB（開発用）
npm run collect

# リモートDB（本番同等環境）
npm run collect -- --remote
```

**注意**: GitHub APIのレート制限（認証済みで5000リクエスト/時間）に注意してください。

## GitHub Actionsの設定（自動データ収集）

詳細は [GitHub Actions設定ガイド](../プロセス/GitHubActions設定.md) を参照してください。

### 必要なシークレット

リポジトリの Settings > Secrets and variables > Actions で以下を設定：

| シークレット名            | 取得方法                                        |
| ------------------------- | ----------------------------------------------- |
| `GH_TRENDS_TOKEN`         | GitHub Personal Access Token                    |
| `CLOUDFLARE_API_TOKEN`    | Cloudflare Dashboard > API Tokens               |
| `CLOUDFLARE_ACCOUNT_ID`   | Cloudflare Dashboard > Workers & Pages          |

## トラブルシューティング

### データベース接続エラー

**症状**: `Error: D1_ERROR: database not found`

**解決策**:
1. `wrangler.jsonc`の`database_id`が正しいか確認
2. リモートDBが作成されているか確認: `npx wrangler d1 list`

### GitHub API レート制限

**症状**: `API rate limit exceeded`

**解決策**:
1. `.env`の`GITHUB_TOKEN`が正しく設定されているか確認
2. 認証済みでも5000リクエスト/時間の制限があるため、時間をおいて再実行

### Wrangler ログインエラー

**症状**: `wrangler login`が失敗する

**解決策**:
1. ブラウザのポップアップブロックを無効化
2. `npx wrangler logout`してから再度`npx wrangler login`

### ポート競合エラー

**症状**: `Error: listen EADDRINUSE: address already in use :::8787`

**解決策**:
1. 既存のプロセスを終了: `lsof -ti:8787 | xargs kill`
2. または別のポートを指定: `npx wrangler dev --port 8788`

## デプロイ

### バックエンドデプロイ

```bash
cd apps/backend
npm run deploy
```

デプロイ後、Workers URLが表示されます（例: `https://gh-trend-tracker.YOUR_SUBDOMAIN.workers.dev`）

### フロントエンドデプロイ

```bash
cd apps/frontend
npm run deploy
```

Cloudflare Pagesへのデプロイ手順は別途 [Cloudflare Pages連携ガイド](https://developers.cloudflare.com/pages/) を参照してください。

## 次のステップ

セットアップが完了したら、以下のドキュメントを参照してください：

- [アーキテクチャ](./アーキテクチャ.md) - システム構成の理解
- [開発ガイド](./開発ガイド.md) - コマンド一覧・コーディング規約
- [API定義](../設計/API定義.md) - エンドポイント仕様
- [開発プロセス](../プロセス/開発プロセス.md) - 開発フロー・品質基準
- [CLAUDE.md](../CLAUDE.md) - AI開発支援用ガイド

## よくある質問（FAQ）

### Q: ローカルDBとリモートDBの使い分けは？

**A**: 開発中は基本的にローカルDBを使用し、本番環境の動作確認時のみリモートDBを使用してください。

### Q: データベースをリセットしたい

**A**: スキーマファイルを再適用すると、既存テーブルは`IF NOT EXISTS`により維持されます。完全にリセットするには：

```bash
# 全テーブル削除後、再作成
npx wrangler d1 execute gh-trends-db \
  --command="DROP TABLE IF EXISTS repositories; DROP TABLE IF EXISTS repo_snapshots;" \
  --remote

npx wrangler d1 execute gh-trends-db --file=schema/schema.sql --remote
```

### Q: npm installが遅い

**A**: npm ciを試すか、node_modulesを削除してから再インストール：

```bash
rm -rf node_modules apps/*/node_modules
npm install
```
