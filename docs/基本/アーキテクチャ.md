# アーキテクチャ

GitHub Trend Trackerのシステム構成とアーキテクチャ設計について説明します。

## システム構成

```
┌─────────────┐     ┌──────────────────┐     ┌─────────────┐
│  Frontend   │────▶│  Backend API     │────▶│ Cloudflare  │
│  (Astro)    │     │  (Hono Workers)  │     │ D1 Database │
└─────────────┘     └──────────────────┘     └─────────────┘
      │                      │
      │                      │
      ▼                      ▼
┌─────────────┐     ┌──────────────────┐
│ Cloudflare  │     │  GitHub Actions  │
│   Pages     │     │  (Daily Batch)   │
└─────────────┘     └──────────────────┘
```

### コンポーネント概要

| コンポーネント       | 技術スタック               | 役割                                   |
| -------------------- | -------------------------- | -------------------------------------- |
| **Frontend**         | Astro + React + TypeScript | トレンド一覧表示、グラフ描画、UI/UX    |
| **Backend API**      | Cloudflare Workers + Hono  | REST API提供、ビジネスロジック         |
| **Database**         | Cloudflare D1 (SQLite)     | リポジトリデータ・メトリクス永続化     |
| **ORM**              | Drizzle ORM                | 型安全なDB操作                         |
| **Batch Processing** | GitHub Actions             | 日次データ収集・メトリクス計算         |
| **Hosting**          | Cloudflare Pages           | 静的サイト配信（CDN）                  |

## プロジェクト構造

このプロジェクトは**モノレポ構成**を採用しています。

```
gh-trend-tracker/
├── apps/                           # アプリケーションコード
│   ├── backend/                    # Cloudflare Workers API
│   │   ├── src/
│   │   │   ├── routes/             # エンドポイント定義
│   │   │   │   ├── batch/          # バッチ処理エンドポイント
│   │   │   │   │   ├── collect-daily.ts
│   │   │   │   │   ├── calculate-metrics.ts
│   │   │   │   │   └── calculate-weekly.ts
│   │   │   │   ├── health.ts
│   │   │   │   ├── trends-daily.ts
│   │   │   │   ├── repositories.ts
│   │   │   │   └── languages.ts
│   │   │   ├── db/
│   │   │   │   └── schema.ts       # Drizzle ORM スキーマ定義
│   │   │   ├── schemas/            # Zodスキーマ（バリデーション用）
│   │   │   ├── shared/             # Backend内共通コード
│   │   │   │   ├── queries.ts      # 共通クエリ関数
│   │   │   │   ├── utils.ts        # ユーティリティ関数
│   │   │   │   └── constants.ts    # 定数定義
│   │   │   └── index.ts            # Honoアプリケーションのエントリーポイント
│   │   ├── openapi/
│   │   │   └── openapi.yaml        # OpenAPI 3.0仕様書
│   │   ├── schema/
│   │   │   └── schema.sql          # D1 SQLスキーマ（Drizzleスキーマと同期必須）
│   │   ├── scripts/
│   │   │   └── collect-data.ts     # ローカル実行用データ収集スクリプト
│   │   ├── test/
│   │   └── wrangler.jsonc          # Cloudflare Workers設定
│   │
│   └── frontend/                   # Astro フロントエンド
│       ├── src/
│       │   ├── components/         # Reactコンポーネント
│       │   ├── pages/              # Astroページ（ルーティング）
│       │   └── lib/                # フロントエンド内共通コード
│       ├── public/                 # 静的アセット
│       └── package.json
│
├── shared/                         # Backend/Frontend間の共有型定義
│   └── src/
│       └── index.ts                # 共有型・インターフェース
│
├── docs/                           # ドキュメント
│   ├── 基本/                       # 基本ドキュメント
│   │   ├── アーキテクチャ.md
│   │   ├── セットアップガイド.md
│   │   ├── 開発ガイド.md
│   │   └── ロードマップ.md
│   ├── プロセス/                   # 開発プロセス・運用
│   │   ├── 開発プロセス.md
│   │   └── GitHubActions設定.md
│   ├── 要件定義/                   # 要件定義
│   └── 設計/                       # システム設計
│
├── .github/workflows/              # CI/CD設定
├── tsconfig.base.json              # 共通TypeScript設定
├── package.json                    # ワークスペース管理
├── CLAUDE.md                       # AI開発支援用ガイド
└── README.md
```

## 共有コードの境界ルール

このプロジェクトは**2階層の共有構造**を採用しています。

| 配置場所                    | 用途                                   | 例                                  |
| --------------------------- | -------------------------------------- | ----------------------------------- |
| `apps/backend/src/shared/`  | **Backend内でのみ**使用するコード      | DBクエリ関数、API固有ユーティリティ |
| `apps/frontend/src/shared/` | **Frontend内でのみ**使用するコード     | UIユーティリティ、フォーマッター    |
| `shared/`                   | **複数アプリ間**で共有する型定義       | APIレスポンス型、共通エンティティ型 |

### 判断基準

- **2つ以上のアプリで使用する場合のみ** `shared/` に配置する
- 単一アプリ内でのみ使用する場合は、そのアプリの `src/shared/` に配置する

### インポート例

```typescript
// apps/backend/src/routes/trends-daily.ts
import type { TrendsDailyResponse } from '@gh-trend-tracker/shared';
import { formatDateISO } from '../shared/utils';

// apps/frontend/src/lib/api.ts
import type { TrendsDailyResponse } from '@gh-trend-tracker/shared';
```

## データベース設計

### スキーマ概要

スナップショットベースのアプローチで5つのメインテーブルを使用：

| テーブル名         | 役割                                       | 主要カラム                                           |
| ------------------ | ------------------------------------------ | ---------------------------------------------------- |
| `repositories`     | GitHubリポジトリの静的メタデータ           | repo_id, full_name, language, description, topics    |
| `repo_snapshots`   | リポジトリ指標の日次スナップショット       | repo_id, stars, forks, snapshot_date                 |
| `metrics_daily`    | 事前計算された日次メトリクス（増加率など） | repo_id, stars_7d_increase, stars_30d_rate           |
| `ranking_weekly`   | 週別トレンドランキング集計結果             | year, week_number, language, rank_data (JSON)        |
| `languages`        | 言語マスタデータ                           | code, name_ja, sort_order                            |

### データフロー

```
1. GitHub API → 日次バッチ収集 → repositories + repo_snapshots
2. repo_snapshots → メトリクス計算バッチ → metrics_daily
3. metrics_daily → 週別集計バッチ → ranking_weekly
4. Frontend ← API ← repositories + metrics_daily + ranking_weekly
```

### 重要な制約

- **`repo_snapshots`**: `(repo_id, snapshot_date)` のUNIQUE制約により1日1スナップショットを保証
- **`metrics_daily`**: 7日間/30日間の増加数・増加率を事前計算してAPI応答を高速化
- **`ranking_weekly`**: JSON形式でランキングデータを保存（柔軟性とパフォーマンスのバランス）

### スキーマ同期の重要性

**CRITICAL**: `apps/backend/src/db/schema.ts`（Drizzle ORM）と`apps/backend/schema/schema.sql`（SQL）は常に同期を保つ必要があります。データベース構造を変更する際は**必ず両方のファイルを更新**してください。

詳細は [テーブル定義](./設計/テーブル定義.md) を参照してください。

## API設計

### エンドポイント分類

| 分類         | パス                                      | 説明                                     |
| ------------ | ----------------------------------------- | ---------------------------------------- |
| **閲覧**     | `GET /api/trends/daily`                   | 日次トレンドランキング                   |
| **閲覧**     | `GET /api/repositories/:repoId`           | リポジトリ詳細＋90日間スター推移         |
| **週別分析** | `GET /api/trends/weekly`                  | 週別トレンドランキング（Phase 2予定）    |
| **バッチ**   | `POST /api/internal/batch/collect-daily`  | 日次データ収集（GitHub Actions専用）     |
| **バッチ**   | `POST /api/internal/batch/calculate-metrics` | メトリクス計算（GitHub Actions専用）   |
| **バッチ**   | `POST /api/internal/batch/calculate-weekly` | 週別集計（GitHub Actions専用）         |

全エンドポイントは`apps/backend/src/routes/`に分離されており、`index.ts`で統合されています。

詳細は [API定義](./設計/API定義.md) を参照してください。

## バッチ処理アーキテクチャ

### 日次バッチフロー

```
UTC 0:00 (JST 9:00 AM)
    ↓
GitHub Actions トリガー
    ↓
┌──────────────────────────────────┐
│ 1. collect-daily                 │
│    GitHub API → DB保存           │
└──────────────────────────────────┘
    ↓
┌──────────────────────────────────┐
│ 2. calculate-metrics             │
│    7日/30日増加率計算            │
└──────────────────────────────────┘
    ↓
┌──────────────────────────────────┐
│ 3. calculate-weekly (日曜のみ)  │
│    週別ランキング集計            │
└──────────────────────────────────┘
```

### バッチエンドポイントの設計方針

- **HTTPエンドポイント方式**: Workers内にバッチロジックを配置し、GitHub Actionsから`curl`で呼び出し
- **べき等性**: 同じ日付で複数回実行しても結果が同じになるように設計
- **エラーハンドリング**: GitHub Actions側でリトライ可能なように適切なHTTPステータスコードを返す

詳細は [GitHub Actions設定ガイド](../プロセス/GitHubActions設定.md) を参照してください。

## TypeScript設定

### 設定の階層構造

```
tsconfig.base.json (共通設定)
    ↓
    ├── apps/backend/tsconfig.json
    │       └── Cloudflare Workers固有設定
    │
    └── apps/frontend/tsconfig.json
            └── Astro固有設定
```

### パスエイリアス

両アプリで `@gh-trend-tracker/shared` を使用して共有型をインポート可能：

```json
{
  "compilerOptions": {
    "paths": {
      "@gh-trend-tracker/shared": ["../../shared/src/index.ts"]
    }
  }
}
```

## Cloudflare Workers制限事項

開発時に考慮すべき制限事項：

| 項目                 | 無料枠制限                     | 対策                                     |
| -------------------- | ------------------------------ | ---------------------------------------- |
| **D1読み取り**       | 500万回/日                     | インデックス最適化、クエリ削減           |
| **D1書き込み**       | 10万回/日                      | バッチ処理でまとめて書き込み             |
| **Worker CPU時間**   | 50ms                           | 重い処理はバッチ化、クエリ最適化         |
| **Workerリクエスト** | 10万回/日                      | キャッシュ活用、不要なAPIコール削減      |

## セキュリティ設計

### CORS設定

現在は開発用に全オリジンを許可：

```typescript
app.use('/*', cors());
```

**本番環境では制限が必要**（Phase 1完了後に対応予定）

### 環境変数とシークレット

| 変数名                   | 用途                   | 設定場所                        |
| ------------------------ | ---------------------- | ------------------------------- |
| `GITHUB_TOKEN`           | GitHub API認証         | `.env` (ローカル), GitHub Secrets |
| `CLOUDFLARE_API_TOKEN`   | Wrangler API操作       | GitHub Secrets                  |
| `CLOUDFLARE_ACCOUNT_ID`  | Cloudflareアカウント識別 | GitHub Secrets                |

## パフォーマンス最適化

### 実装済み最適化

1. **事前計算メトリクス**: `metrics_daily`で7日/30日の増加率を事前計算
2. **インデックス最適化**: `snapshot_date`, `language`, `repo_id`に複合インデックス
3. **ページネーション**: デフォルト100件、最大制限で大量データ取得を防止
4. **JSON圧縮**: 週別ランキングはJSON形式で保存し、読み取り回数削減

### 成功指標

- LCP 2秒以内
- API応答時間 P95 200ms以内
- 稼働率 99%以上

## 開発フェーズ

| Phase                | 状態   | 主な機能                                                                                                            |
| -------------------- | ------ | ------------------------------------------------------------------------------------------------------------------- |
| **Phase 1 (MVP)**    | 現在   | トレンドランキング一覧（Top 100）、言語フィルタリング、7日/30日スター増加数表示、リポジトリ詳細（90日間推移グラフ） |
| **Phase 2 (拡張)**   | 計画中 | リポジトリ名検索、お気に入り（ローカルストレージ）、週別トレンドランキング、ソート機能                              |
| **Phase 3 (収益化)** | 将来   | GitHub OAuth認証、AI要約機能（課金/無料プレビュー）、Stripe決済連携                                                 |

詳細は [ロードマップ](./ロードマップ.md) を参照してください。

## 関連ドキュメント

- [セットアップガイド](./セットアップガイド.md) - 環境構築手順
- [開発ガイド](./開発ガイド.md) - コマンド一覧・コーディング規約
- [API定義](../設計/API定義.md) - エンドポイント詳細仕様
- [テーブル定義](../設計/テーブル定義.md) - データベーススキーマ
- [開発プロセス](../プロセス/開発プロセス.md) - 開発フロー・品質基準
- [CLAUDE.md](../CLAUDE.md) - AI開発支援用ガイド
