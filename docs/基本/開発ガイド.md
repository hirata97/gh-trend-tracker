# 開発ガイド

GitHub Trend Trackerの開発時に必要な技術情報とコーディング規約をまとめたガイドです。

## よく使うコマンド

### 開発サーバー

```bash
# Backend開発サーバー（ルートから）
npm run dev:backend
# → http://localhost:8787

# Frontend開発サーバー（ルートから）
npm run dev:frontend
# → http://localhost:4321

# 各ディレクトリで直接作業
cd apps/backend && npm run dev
cd apps/frontend && npm run dev
```

### テスト

```bash
# Backend テスト（ルートから）
npm run test:backend

# または
cd apps/backend && npm run test

# 全ワークスペースのテスト
npm run test
```

### ビルドとデプロイ

```bash
# ルートから
npm run build:backend
npm run build:frontend
npm run deploy:backend

# 各ディレクトリから
cd apps/backend && npm run deploy
cd apps/frontend && npm run deploy
```

### データベース操作

```bash
cd apps/backend

# WranglerからTypeScript型を生成
npm run cf-typegen

# データベーススキーマを適用（リモートD1）
npx wrangler d1 execute gh-trends-db --file=schema/schema.sql --remote

# データベースを直接クエリ
npx wrangler d1 execute gh-trends-db --command="SELECT * FROM repositories LIMIT 10" --remote

# ローカル開発用データベース
npx wrangler d1 execute gh-trends-db --file=schema/schema.sql --local
```

### その他の便利コマンド

```bash
# Lint実行
npm run lint

# Lintエラー自動修正
npm run lint:fix

# コード整形
npm run format

# 型チェック
npm run type-check

# データ収集（ローカル）
cd apps/backend && npm run collect

# データ収集（リモート）
cd apps/backend && npm run collect -- --remote
```

## コーディング規約

### ディレクトリ配置ルール

| 配置場所                    | 用途                               | 例                                  |
| --------------------------- | ---------------------------------- | ----------------------------------- |
| `apps/backend/src/routes/`  | APIエンドポイント定義              | `trends-daily.ts`, `repositories.ts` |
| `apps/backend/src/shared/`  | **Backend内でのみ**使用するコード  | DBクエリ関数、API固有ユーティリティ |
| `apps/frontend/src/shared/` | **Frontend内でのみ**使用するコード | UIユーティリティ、フォーマッター    |
| `shared/`                   | **複数アプリ間**で共有する型定義   | APIレスポンス型、共通エンティティ型 |

**判断基準**: 2つ以上のアプリで使用する場合のみ `shared/` に配置する。

### コードスタイル

#### TypeScript

- **厳格モード有効**: `tsconfig.json`で`strict: true`
- **共有型のインポート**: 全ての共有型は`@gh-trend-tracker/shared`からimport

```typescript
// 正しい例
import type { TrendsDailyResponse } from '@gh-trend-tracker/shared';

// 間違った例
import type { TrendsDailyResponse } from '../../../shared/src/index';
```

#### 未使用変数の扱い

アンダースコアプレフィックス（`_var`）で回避せず、根本的に解決する。

```typescript
// ❌ 悪い例
for (const [_key, value] of map.entries()) {
  console.log(value);
}

// ✅ 良い例
for (const value of map.values()) {
  console.log(value);
}

// ⚠️ 例外: コールバックで位置が固定される場合のみ許可
array.map((_item, index) => index);
```

#### コメント言語

コード内のコメントは**日本語**で記述する。

```typescript
// ✅ 正しい
// リポジトリのスター数推移を取得
const history = await getStarHistory(repoId);

// ❌ 間違い
// Get star history for the repository
const history = await getStarHistory(repoId);
```

### ファイル配置規約

#### エンドポイントの追加

新しいエンドポイントは`apps/backend/src/routes/`に追加：

```typescript
// apps/backend/src/routes/new-endpoint.ts
import { Hono } from 'hono';

const newEndpoint = new Hono();

newEndpoint.get('/', async (c) => {
  // 実装
});

export default newEndpoint;
```

`apps/backend/src/index.ts`で統合：

```typescript
import newEndpoint from './routes/new-endpoint';

app.route('/api/new-endpoint', newEndpoint);
```

#### 共通クエリの追加

複数ルートで使用するクエリは`apps/backend/src/shared/queries.ts`に追加：

```typescript
// apps/backend/src/shared/queries.ts
export async function getCommonData(db: D1Database) {
  // 共通クエリ実装
}
```

#### 共有型の定義

Backend/Frontend間で共有する型は`shared/src/index.ts`に定義：

```typescript
// shared/src/index.ts
export interface NewResponse {
  id: string;
  name: string;
}
```

## 環境変数とバインディング

### Cloudflare Workers バインディング

| バインディング名 | 型           | 説明                   |
| ---------------- | ------------ | ---------------------- |
| `DB`             | `D1Database` | Cloudflare D1データベース |

設定場所: `apps/backend/wrangler.jsonc`

```jsonc
{
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "gh-trends-db",
      "database_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    }
  ]
}
```

### 環境変数

ローカル開発用に`apps/backend/.env`に格納：

```env
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**注意**: `.env`ファイルはGitにコミットしない（`.gitignore`に含まれている）

## データベース設計の重要事項

### スキーマ同期

**CRITICAL**: `apps/backend/src/db/schema.ts`（Drizzle ORM）と`apps/backend/schema/schema.sql`（SQL）は常に同期を保つ必要があります。

データベース構造を変更する際は**必ず両方のファイルを更新**してください。

### テーブル制約

- **1リポジトリにつき1日1スナップショット**: `(repo_id, snapshot_date)`のUNIQUE制約で強制
- **外部キー制約**: `repo_snapshots.repo_id` → `repositories.repo_id` (CASCADE削除)
- **日付形式**: ISO日付文字列（YYYY-MM-DD）で格納
- **タイムスタンプ**: ISO 8601形式のTEXT型を使用

詳細は [テーブル定義](./設計/テーブル定義.md) を参照してください。

## TypeScript設定

### 設定の階層構造

```
tsconfig.base.json (共通設定)
    ↓
    ├── apps/backend/tsconfig.json
    │       └── Cloudflare Workers固有設定
    │
    └── apps/frontend/tsconfig.json
            └── Astro固有設定
```

### パスエイリアス

両アプリで`@gh-trend-tracker/shared`を使用して共有型をインポート可能：

```json
{
  "compilerOptions": {
    "paths": {
      "@gh-trend-tracker/shared": ["../../shared/src/index.ts"]
    }
  }
}
```

## Cloudflare Workers制限事項

開発時に考慮すべき制限事項：

| 項目                 | 無料枠制限                     | 対策                                     |
| -------------------- | ------------------------------ | ---------------------------------------- |
| **D1読み取り**       | 500万回/日                     | インデックス最適化、クエリ削減           |
| **D1書き込み**       | 10万回/日                      | バッチ処理でまとめて書き込み             |
| **Worker CPU時間**   | 50ms                           | 重い処理はバッチ化、クエリ最適化         |
| **Workerリクエスト** | 10万回/日                      | キャッシュ活用、不要なAPIコール削減      |

### ベストプラクティス

- D1クエリは非同期でPromiseを返す → 必ず`await`を使用
- 大規模テーブルの全クエリにインデックスを使用
- N+1クエリ問題を避ける（JOINまたは一括取得を使用）

## 重要な注意事項

### データベースID管理

`wrangler.jsonc`のD1データベースIDは**環境固有**です。

新しいデータベースを作成する場合を除き、このIDの変更をコミットしないでください。

### CORS設定

現在は開発用に全オリジンを許可：

```typescript
app.use('/*', cors());
```

**本番環境では制限が必要**（Phase 1完了後に対応予定）

### エラーハンドリング

現在、全エンドポイントがエラーをキャッチし、汎用エラーメッセージで500を返します。

本番環境では以下の対応が必要：
- より具体的なエラーメッセージ
- エラーログの記録
- ユーザーフレンドリーなエラー表示

### クエリ制限

パフォーマンスとコスト最適化のため、以下の制限を設定：

- トレンドエンドポイント: 100件/リクエスト
- 履歴エンドポイント: 90日間のデータ

## 要件ID体系

ドキュメント内で使用される要件ID：

- `req-XXX`: 業務要件（34件）
- `fun-XXX`: 機能要件（54件）
- `non-XXX`: 非機能要件（16件）
- `bac-XXX`: バックエンドAPI（14件）
- `scr-XXX`: 画面定義（11件）

詳細は [要件定義](./要件定義/) を参照してください。

## 開発時のチェックリスト

新規機能追加や大規模な改修を行う前に、以下を確認すること：

1. **要件確認**: `docs/要件定義/` で関連する業務要件・機能要件を確認
2. **設計確認**: `docs/設計/` でAPI定義・テーブル定義・画面設計を確認
3. **フェーズ確認**: 実装対象がどのPhaseに属するか確認（Phase 1が優先）
4. **スキーマ同期**: DBスキーマ変更時は`schema.ts`と`schema.sql`の両方を更新
5. **型定義**: 共有型が必要なら`shared/src/index.ts`に追加
6. **テスト**: 新機能には対応するテストを追加
7. **ドキュメント**: API変更時は`docs/設計/API定義.md`を更新

詳細は [開発プロセス](../プロセス/開発プロセス.md) を参照してください。

## 将来拡張: Turborepo導入判断基準

現時点ではTurborepoを導入せず、npm workspacesのみで運用する。

以下の条件を満たした場合に導入を検討：

| 条件             | 現状                   | 閾値                     |
| ---------------- | ---------------------- | ------------------------ |
| アプリ数         | 2（backend, frontend） | **3以上**                |
| 全体ビルド時間   | 数秒                   | **1分以上**              |
| 開発者数         | 1人                    | **3人以上**              |
| キャッシュ要求   | 不要                   | リモートキャッシュ必要時 |

## 関連ドキュメント

- [アーキテクチャ](./アーキテクチャ.md) - システム構成・データフロー
- [セットアップガイド](./セットアップガイド.md) - 環境構築手順
- [API定義](../設計/API定義.md) - エンドポイント詳細
- [テーブル定義](../設計/テーブル定義.md) - データベーススキーマ
- [開発プロセス](../プロセス/開発プロセス.md) - 開発フロー・品質基準
