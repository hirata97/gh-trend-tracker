# システム化業務フロー

本システムにおける主要業務フローを示す。

## 全体フロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant BE as バックエンド
    participant DB as D1データベース
    participant Batch as 日次バッチ
    participant GitHub as GitHub API
    participant AI as AI要約API

    %% 日次バッチ処理
    rect rgb(240, 248, 255)
        Note over Batch,GitHub: 日次データ収集（UTC 0:00）
        Batch->>GitHub: 言語別トレンドリポジトリ取得
        GitHub-->>Batch: リポジトリデータ500件
        Batch->>DB: 日次スナップショットを保存
        Batch->>DB: 7日/30日増加数計算保存
        Batch->>DB: 週別ランキングを集計保存
    end

    %% トレンド閲覧フロー
    rect rgb(255, 250, 240)
        Note over User,DB: トレンド閲覧フロー
        User->>FE: トレンドランキング閲覧/増加率ソート
        FE->>BE: ランキングとメトリクス要求
        BE->>DB: 最新ランキングデータ取得
        DB-->>BE: 増加数とスター数を含むデータ
        BE-->>FE: トレンド一覧表示
    end

    %% 詳細閲覧フロー
    rect rgb(240, 255, 240)
        Note over User,DB: リポジトリ詳細閲覧フロー
        User->>FE: リポジトリ詳細ページへ遷移
        FE->>BE: 過去90日間スター推移履歴要求
        BE->>DB: スナップショット履歴データ取得
        DB-->>BE: 90日間の時系列データ
        BE-->>FE: 成長曲線をグラフ表示
    end

    %% AI要約閲覧フロー（課金ユーザー）
    rect rgb(255, 240, 245)
        Note over User,AI: AI要約閲覧フロー
        User->>FE: AI要約閲覧を要求
        FE->>BE: ユーザー権限と要約キャッシュ確認
        BE->>DB: 課金プラン確認と要約取得
        DB-->>BE: Pro確認とキャッシュデータ
        BE-->>FE: スライド形式要約表示
    end

    %% オンデマンド生成フロー
    rect rgb(245, 245, 255)
        Note over User,AI: オンデマンド生成フロー
        User->>FE: 要約が未生成オンデマンド生成要求
        FE->>BE: 生成コストクレジット消費
        BE->>GitHub: README等メタ情報取得
        GitHub-->>BE: リポジトリ生データ
        BE->>AI: 要約生成リクエスト
        AI-->>BE: 生成済みサマリーJSON
        BE->>DB: 要約とトークン消費ログを保存
        DB-->>BE: 保存完了
        BE-->>FE: 新しい要約を表示
    end
```

## フロー説明

### 1. 日次データ収集（バッチ処理）

| ステップ | 処理内容 |
|---------|---------|
| 1 | GitHub APIから言語別トレンドリポジトリを取得（最大500件） |
| 2 | スナップショットデータ（スター数、フォーク数等）をDBに保存 |
| 3 | 7日間/30日間のスター増加数を計算・保存 |
| 4 | 週別ランキングを集計・保存 |

### 2. トレンド閲覧フロー

| ステップ | 処理内容 |
|---------|---------|
| 1 | ユーザーがトップページにアクセス |
| 2 | フロントエンドがAPIにランキングデータを要求 |
| 3 | バックエンドがDBから最新ランキングを取得 |
| 4 | 増加数・スター数を含むデータを返却 |
| 5 | フロントエンドが一覧を表示 |

### 3. リポジトリ詳細閲覧フロー

| ステップ | 処理内容 |
|---------|---------|
| 1 | ユーザーがリポジトリ詳細ページへ遷移 |
| 2 | 過去90日間のスナップショット履歴を要求 |
| 3 | DBから時系列データを取得 |
| 4 | 折れ線グラフとして成長曲線を表示 |

### 4. AI要約閲覧フロー（課金ユーザー）

| ステップ | 処理内容 |
|---------|---------|
| 1 | ユーザーがAI要約閲覧を要求 |
| 2 | ユーザーの課金プランを確認 |
| 3 | キャッシュ済み要約があれば取得 |
| 4 | スライド形式で要約を表示 |

### 5. オンデマンド生成フロー

| ステップ | 処理内容 |
|---------|---------|
| 1 | ユーザーが未生成リポジトリの要約生成を要求 |
| 2 | クレジット残高を確認・消費 |
| 3 | GitHub APIからREADME等のメタ情報を取得 |
| 4 | AI APIで構造化要約を生成 |
| 5 | 生成結果をDBに保存 |
| 6 | ユーザーに新しい要約を表示 |
