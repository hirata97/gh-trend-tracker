# テーブル定義

データベース（Cloudflare D1 / SQLite）のテーブル設計を定義する。

## テーブル一覧

| ID | テーブル名 | 概要 |
|----|-----------|------|
| tab-REP | repositories | リポジトリマスタ |
| tab-SNP | repo_snapshots | 日次スナップショット |
| tab-MET | metrics_daily | 日次メトリクス（増加数/率） |
| tab-RKL | ranking_weekly | 週別ランキング集計 |
| tab-USR | users | ユーザー情報 |
| tab-AIS | ai_summaries | AI要約データ |
| tab-LNG | languages | 言語マスタ |

---

## tab-REP: repositories

リポジトリの基本情報を管理するマスタテーブル。

| 項目名 | データ形式 | 制約 | 初期値 | 外部キー | 概要 |
|--------|-----------|------|--------|---------|------|
| id | UUID | PRIMARY KEY, NOT NULL | GEN_RANDOM_UUID() | | リポジトリを一意に識別するID |
| github_id | BIGINT | UNIQUE, NOT NULL | | | GitHubが割り当てるリポジトリの数値ID |
| full_name | TEXT | UNIQUE, NOT NULL | | | リポジトリのフルネーム（例: owner/repo-name）。検索機能で使用 ([fun-016](../requirements/機能要件一覧.md#fun-016-リポジトリ名検索実行)) |
| description | TEXT | | NULL | | リポジトリの概要説明 ([fun-002](../requirements/機能要件一覧.md#fun-002-ランキングリポジトリ情報の取得), [fun-003](../requirements/機能要件一覧.md#fun-003-リポジトリ基本情報のリスト表示)) |
| language | TEXT | NOT NULL | 'unknown' | languages.code | リポジトリの主要言語。フィルタリングに使用 ([fun-007](../requirements/機能要件一覧.md#fun-007-言語フィルタリングの適用)) |
| stargazers_count | INT | NOT NULL | 0 | | 現在の総スター数。ソートに使用 ([fun-010](../requirements/機能要件一覧.md#fun-010-スター総数によるソート実行)) |
| forks_count | INT | NOT NULL | 0 | | 現在の総フォーク数 |
| topics | JSONB | | [] | | GitHubトピックスのリスト ([fun-048](../requirements/機能要件一覧.md#fun-048-リポジトリ詳細ページでのトピックス情報表示)) |
| last_synced_at | TIMESTAMPTZ | NOT NULL | NOW() | | GitHub APIから最後に情報を取得した日時 |

---

## tab-SNP: repo_snapshots

リポジトリの日次スナップショットを保存するテーブル。

| 項目名 | データ形式 | 制約 | 初期値 | 外部キー | 概要 |
|--------|-----------|------|--------|---------|------|
| id | BIGINT | PRIMARY KEY, NOT NULL, AUTO INCREMENT | | | スナップショットレコードのID |
| repo_id | UUID | NOT NULL | | repositories.id | 対象リポジトリID |
| snapshot_date | DATE | NOT NULL, UNIQUE(repo_id, snapshot_date) | CURRENT_DATE | | スナップショットを取得した日付 ([fun-024](../requirements/機能要件一覧.md#fun-024-日次スナップショットデータのdb保存)) |
| stargazers_count | INT | NOT NULL | 0 | | その日の総スター数。過去90日間の推移データとして使用 ([fun-012](../requirements/機能要件一覧.md#fun-012-過去90日間のスター推移データ取得), [fun-013](../requirements/機能要件一覧.md#fun-013-スター推移グラフの描画)) |
| daily_increase | INT | NOT NULL | 0 | | 前日からのスター増加数。グラフのツールチップに使用 ([fun-045](../requirements/機能要件一覧.md#fun-045-グラフデータのツールチップ表示)) |

**インデックス**: `(repo_id, snapshot_date)` UNIQUE

---

## tab-MET: metrics_daily

日次で計算されるメトリクス（7日/30日の増加数・増加率）を保存するテーブル。

| 項目名 | データ形式 | 制約 | 初期値 | 外部キー | 概要 |
|--------|-----------|------|--------|---------|------|
| repo_id | UUID | PRIMARY KEY (Part 1), NOT NULL | | repositories.id | 対象リポジトリID |
| calculated_date | DATE | PRIMARY KEY (Part 2), NOT NULL | CURRENT_DATE | | 計算を行った日付 ([fun-028](../requirements/機能要件一覧.md#fun-028-計算済み増加率のdb保存)) |
| stars_7d_increase | INT | NOT NULL | 0 | | 過去7日間のスター増加数 ([fun-004](../requirements/機能要件一覧.md#fun-004-7日間スター増加数の表示)) |
| stars_30d_increase | INT | NOT NULL | 0 | | 過去30日間のスター増加数 ([fun-005](../requirements/機能要件一覧.md#fun-005-30日間スター増加数の表示)) |
| stars_7d_rate | REAL | NOT NULL | 0.0 | | 過去7日間のスター増加率。ランキングのソート基準 ([fun-008](../requirements/機能要件一覧.md#fun-008-7日間増加率数によるソート実行)) |
| stars_30d_rate | REAL | NOT NULL | 0.0 | | 過去30日間のスター増加率。ランキングのソート基準 ([fun-009](../requirements/機能要件一覧.md#fun-009-30日間増加率数によるソート実行)) |

**複合主キー**: `(repo_id, calculated_date)`

---

## tab-RKL: ranking_weekly

週別トレンドランキングの集計結果を保存するテーブル。

| 項目名 | データ形式 | 制約 | 初期値 | 外部キー | 概要 |
|--------|-----------|------|--------|---------|------|
| id | UUID | PRIMARY KEY, NOT NULL | GEN_RANDOM_UUID() | | 週別ランキング集計レコードID |
| year | INT | NOT NULL, UNIQUE(year, week_number, language) | | | 集計対象の年 |
| week_number | INT | NOT NULL | | | ISO週番号 ([fun-021](../requirements/機能要件一覧.md#fun-021-利用可能な過去週リスト取得)) |
| language | TEXT | NOT NULL | 'all' | languages.code | 集計対象の言語 |
| rank_data | JSONB | NOT NULL | | | 週別トップ10/100のランキング結果データ。事前集計済み ([fun-019](../requirements/機能要件一覧.md#fun-019-指定された週のランキングデータ取得), [fun-026](../requirements/機能要件一覧.md#fun-026-週別集計結果のdb保存)) |

**rank_data構造**:
```json
[
  {"rank": 1, "repo_id": "uuid", "star_increase": 500, "repo_full_name": "owner/repo"}
]
```

**UNIQUE制約**: `(year, week_number, language)`

---

## tab-USR: users

ユーザー情報と課金状態を管理するテーブル。

| 項目名 | データ形式 | 制約 | 初期値 | 外部キー | 概要 |
|--------|-----------|------|--------|---------|------|
| id | UUID | PRIMARY KEY, NOT NULL | GEN_RANDOM_UUID() | | ユーザーを一意に識別するID |
| github_id | BIGINT | UNIQUE, NOT NULL | | | GitHub OAuthで取得したユーザーID ([fun-031](../requirements/機能要件一覧.md#fun-031-oauthコールバック時のユーザー登録ログイン処理)) |
| username | TEXT | NOT NULL | | | GitHubのユーザー名 |
| plan | TEXT | NOT NULL | 'FREE' | | 現在の課金プラン ('FREE', 'PRO', 'ENTERPRISE') ([fun-033](../requirements/機能要件一覧.md#fun-033-ユーザーの課金プラン情報の登録更新), [fun-034](../requirements/機能要件一覧.md#fun-034-機能アクセス権限判定)) |
| credits_remaining | INT | NOT NULL | 0 | | AIオンデマンド生成に使用可能な残クレジット ([fun-040](../requirements/機能要件一覧.md#fun-040-オンデマンド生成要求時のクレジット制限の確認)) |
| stripe_customer_id | TEXT | UNIQUE | NULL | | Stripeの顧客ID。課金連携用 ([fun-051](../requirements/機能要件一覧.md#fun-051-決済成功時のユーザー課金プランのアクティベーション処理)) |

---

## tab-AIS: ai_summaries

AI生成された要約データを保存するテーブル。

| 項目名 | データ形式 | 制約 | 初期値 | 外部キー | 概要 |
|--------|-----------|------|--------|---------|------|
| repo_id | UUID | PRIMARY KEY (Part 1), NOT NULL | | repositories.id | 対象リポジトリID |
| language | TEXT | PRIMARY KEY (Part 2), NOT NULL | 'ja' | | 要約の生成言語 ('ja' or 'en') |
| generated_at | TIMESTAMPTZ | NOT NULL | NOW() | | 要約が最後に生成された日時 ([fun-041](../requirements/機能要件一覧.md#fun-041-ai-apiを呼び出しリポジトリ概要を生成)) |
| summary_data | JSONB | NOT NULL | | | AI生成された構造化要約データ ([fun-035](../requirements/機能要件一覧.md#fun-035-ai要約全文の取得と表示課金ユーザー向け), [fun-041](../requirements/機能要件一覧.md#fun-041-ai-apiを呼び出しリポジトリ概要を生成)) |

**summary_data構造**:
```json
{
  "title": "Example Summary",
  "abstract": "This is an abstract.",
  "sections": [
    {"heading": "Key Feature 1", "content": "Detail 1"}
  ]
}
```

**複合主キー**: `(repo_id, language)`

---

## tab-LNG: languages

言語マスタテーブル。

| 項目名 | データ形式 | 制約 | 初期値 | 外部キー | 概要 |
|--------|-----------|------|--------|---------|------|
| code | TEXT | PRIMARY KEY, NOT NULL | | | 言語の識別コード（例: 'ts', 'py', 'all'） |
| name_ja | TEXT | NOT NULL | | | UI表示用の日本語名 ([fun-006](../requirements/機能要件一覧.md#fun-006-言語選択ui提供)) |
| sort_order | INT | NOT NULL | 100 | | UI上での表示順序 |
